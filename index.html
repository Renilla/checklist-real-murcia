<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Checklist Cromos Real Murcia</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #800000;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .title-icon {
      width: 50px;
      height: 65px;
      vertical-align: middle;
    }
    .global-progress {
      display: inline-block;
      vertical-align: middle;
      margin-left: 15px;
    }
    .collection {
      background: #fff;
      margin: 15px 0;
      border-radius: 5px;
      overflow: hidden;
    }
    .collection-header {
      padding: 10px 15px;
      font-weight: bold;
      font-size: 1.5em;
      color: #800000;
      cursor: pointer;
      background: #e0e0e0;
      display: flex;
      align-items: center;
    }
    .progress-circle {
      width: 50px;
      height: 50px;
      flex-shrink: 0;
    }
    .collection-image {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      margin: 0 10px;
      flex-shrink: 0;
    }
    .collection-title {
      flex: 1;
      text-align: center;
    }
    .collection-body {
      display: none;
      padding: 10px 15px;
      background: #fafafa;
    }
    .collection-body ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .collection-body li {
      margin: 8px 0;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ddd;
      background: #fff;
      transition: background 0.2s ease, color 0.2s ease;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .collection-body li.checked {
      background: #e0e0e0;
      color: #555;
      text-decoration: line-through;
    }
    .collection-body input[type="checkbox"] {
      display: none;
    }
    .arrow {
      transition: transform 0.3s ease;
      margin-left: 10px;
    }
    .arrow.open {
      transform: rotate(90deg);
    }
  </style>
</head>
<body>
  <h1>
    <img src="images/icono-principal.jpg" alt="Icono" class="title-icon">
    Checklist Cromos Real Murcia
    <div class="global-progress" id="global-progress-svg"></div>
  </h1>

  <div id="collections"></div>

  <!-- Script principal convertido a módulo para usar Firebase -->
  <script type="module">
    // --- Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEWxXIHlD8ezQTdklpvys2FNjFu5bqd2s",
      authDomain: "checklist-real-murcia.firebaseapp.com",
      databaseURL: "https://checklist-real-murcia-default-rtdb.firebaseio.com",
      projectId: "checklist-real-murcia",
      storageBucket: "checklist-real-murcia.firebasestorage.app",
      messagingSenderId: "760418626321",
      appId: "1:760418626321:web:5aa01ddfd53e9be79bbab0",
      measurementId: "G-DWVT87PSEZ"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // --- Tu código original (sin cambios visuales) ---
    const colecciones = {
      "Megacracks 2004/05": {
        cromos: ["Escudo Real Murcia", "Acciari"],
        portada: "images/megacracks2007-08.png"
      },
      "Megacracks 2005/06": {
        cromos: ["Escudo Real Murcia"],
        portada: "images/megacracks2007-08.png"
      },
      "Megacracks 2006/07": {
        cromos: ["Escudo Real Murcia"],
        portada: "images/megacracks2007-08.png"
      },
      "Las Fichas de la Liga 2007": {
        cromos: ["Escudo Murcia", "Plantilla Murcia", "Notario", "Juanma", "Marañón", "Ochoa", "Paco Peña", "Cuadrado",
        "Ramón", "Pignol", "Abel", "Pablo Ruiz", "Samuel", "Jofre", "Pedro León", "Iván Alonso", "Aranda", "Antoñito",
        "Tato", "Richi", "Gallardo", "A. Martín"],
        portada: "images/ligaeste2007-08.png"
      },
      "Liga Este 2007/08": {
        cromos: ["Escudo", "Entrenador Lucas Alcaraz", "Notario", "Carini", "Pignol", "Cuadrado", "Ochoa", 
        "César Arzo", "Paco Peña", "Marañón", "Abel", "Bruno", "Pablo García", "Richi", "Pedro León", "Gallardo",
        "De Lucas", "Jofre", "Regueiro", "Iván Alonso", "Iñigo Vélez", "Henok Goitom", "Mejía", "Curro Torres", 
        "Baiano", "Movilla", "De Coz", "Kabous", "Rosinei"],
        portada: "images/ligaeste2007-08.png"
      },
      "Megacracks 2007/08": {
        cromos: ["Escudo", "Notario", "Carini", "Pignol", "Cuadrado", "Ochoa", "César Arzo", "Paco Peña", "Marañón",
        "Curro Torres", "Abel", "Pablo García", "De Lucas", "Richi", "Pedro León", "Regueiro", "Gallardo", "Jofre",
        "Iñigo Vélez", "Henok Goitom", "Iván Alonso", "Mejía", "Baiano", "Movilla"],
        portada: "images/megacracks2007-08.png"
      },
      "Ediciones Estadio Liga 2007/08": {
        cromos: ["Escudo", "Entrenador Lucas Alcaraz", "Notario", "Carini", "Pignol", "Cuadrado", "Ochoa", "Paco Peña",
        "Marañón", "César Arzo", "Richi", "De Lucas", "Regueiro", "Bruno", "Pedro León", "Gallardo", "Jofre", "Iván Alonso",
        "Henok Goitom", "Mejía", "Baiano"],
        portada: "images/megacracks2007-08.png"
      },
      "Las Fichas de la Liga 2008": {
        cromos: ["Escudo", "Plantilla", "Himno", "Entrenador Lucas Alcaraz", "Notario", "Carini", "Pignol", "Marañón",
        "Cuadrado", "Ochoa", "Paco Peña", "César Arzo", "Mejía", "Abel", "Pablo García", "Bruno", "De Lucas", "Richi",
        "Gallardo", "Baiano", "Jofre", "Iván Alonso", "Henok Goitom", "Iñigo Vélez", "Iban Cuadrado El Capitán Horizontal/Security Horizontal/Security Vertical/Vertical",
        "Notario El Crack Horizontal/Security Horizontal/Security Vertical/Vertical", "Iván Alonso El Mejor Horizontal/Security Horizontal/Security Vertical/Vertical",
        "Curro Torres", "Regueiro", "Movilla", "Notario TOP Platinum/Brillantes/Security Horizontal/Security Vertical",
        "Paco Peña TOP Platinum/Brillantes/Security Horizontal/Security Vertical", "Regueiro TOP Platinum/Brillantes/Security Horizontal/Security Vertical",
        "De Coz", "Rosinei", "Aquino"],
        portada: "images/megacracks2007-08.png"
      },
      "Panini Play Liga 2007/08": {
        cromos: ["Notario", "Curro Torres", "Mejía", "César Arzo", "Pablo García", "Movilla", "De Lucas", "Regueiro",
        "Henok Goitom", "Baiano", "Iván Alonso"],
        portada: "images/megacracks2007-08.png"
      },
      "Liga Este 2008/09": {
        cromos: ["Escudo Real Murcia Liga Adelante"],
        portada: "images/ligaeste2007-08.png"
      },
      "Megacracks 2008/09": {
        cromos: ["Escudo Real Murcia", "Iván Alonso"],
        portada: "images/megacracks2007-08.png"
      },
      "Las Fichas de la Liga 2009": {
        cromos: ["Escudo Murcia", "Plantilla Murcia", "Alberto", "Paco Peña", "Lillo", "Ochoa", "De Coz", "Mejía", "Cuellar",
        "Guerrero", "Núñez", "Bruno", "Dialiba", "Capdevila", "De Lucas", "Aquino", "Despotovic", "Iván Alonso", "Sikora",
        "Elia", "Marañón", "Movilla", "Montoro"],
        portada: "images/ligaeste2007-08.png"
      }
    };

    const contenedor = document.getElementById('collections');
    const globalProgressContainer = document.getElementById('global-progress-svg');

    // Sustituye localStorage por Firebase
    let progresoGuardado = {};

    async function cargarProgreso() {
      const snapshot = await get(ref(db, 'checklistMurciaColecciones'));
      if (snapshot.exists()) {
        progresoGuardado = snapshot.val();
      }
    }

    async function guardarProgreso() {
      await set(ref(db, 'checklistMurciaColecciones'), progresoGuardado);
    }

    function calcularPorcentaje(nombreColeccion) {
      const total = colecciones[nombreColeccion].cromos.length;
      const marcados = Object.values(progresoGuardado[nombreColeccion] || {}).filter(v => v).length;
      return (marcados / total) * 100;
    }

    function calcularPorcentajeGlobal() {
      let total = 0, marcados = 0;
      Object.keys(colecciones).forEach(nombre => {
        total += colecciones[nombre].cromos.length;
        marcados += Object.values(progresoGuardado[nombre] || {}).filter(v => v).length;
      });
      return total ? (marcados / total) * 100 : 0;
    }

    function crearSVGPorcentaje(porcentaje, tamaño = 50) {
      const radius = tamaño/2 - 2;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference - (porcentaje / 100) * circumference;

      return `
        <svg class="progress-circle" width="${tamaño}" height="${tamaño}">
          <circle cx="${tamaño/2}" cy="${tamaño/2}" r="${radius}" stroke="#ccc" stroke-width="4" fill="none"/>
          <circle cx="${tamaño/2}" cy="${tamaño/2}" r="${radius}" stroke="#800000" stroke-width="4" fill="none"
            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}" transform="rotate(-90 ${tamaño/2} ${tamaño/2})" />
          <text x="50%" y="50%" text-anchor="middle" dy=".3em" font-size="15" fill="#800000">${Math.round(porcentaje)}%</text>
        </svg>
      `;
    }

    function actualizarProgresoGlobal() {
      globalProgressContainer.innerHTML = crearSVGPorcentaje(calcularPorcentajeGlobal(), 50);
    }

    // Inicialización respetando tu lógica original
    async function init() {
      await cargarProgreso();

      // Numeración global
      let globalIndex = 1;

      Object.keys(colecciones).forEach(nombreColeccion => {
        const data = colecciones[nombreColeccion];
        const collectionDiv = document.createElement('div');
        collectionDiv.className = 'collection';

        const porcentaje = calcularPorcentaje(nombreColeccion);
        const header = document.createElement('div');
        header.className = 'collection-header';
        header.innerHTML = `
          <span class="progress-svg">${crearSVGPorcentaje(porcentaje)}</span>
          <img class="collection-image" src="${data.portada}" alt="${nombreColeccion}">
          <span class="collection-title">${nombreColeccion}</span>
          <span class="arrow">▶</span>
        `;
        const svgContainer = header.querySelector('.progress-svg');

        const body = document.createElement('div');
        body.className = 'collection-body';
        const ul = document.createElement('ul');

        data.cromos.forEach((cromo, index) => {
          const li = document.createElement('li');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.checked = progresoGuardado[nombreColeccion]?.[index] || false;

          if (checkbox.checked) li.classList.add('checked');

          li.addEventListener('click', async () => {
            checkbox.checked = !checkbox.checked;
            if (!progresoGuardado[nombreColeccion]) {
              progresoGuardado[nombreColeccion] = {};
            }
            progresoGuardado[nombreColeccion][index] = checkbox.checked;

            li.classList.toggle('checked', checkbox.checked);
            svgContainer.innerHTML = crearSVGPorcentaje(calcularPorcentaje(nombreColeccion));
            actualizarProgresoGlobal();

            // Guardar en Firebase
            await guardarProgreso();
          });

          li.appendChild(checkbox);
          const span = document.createElement('span');
          span.textContent = `${globalIndex++}. ${cromo}`;
          span.style.fontWeight = 'bold';
          li.appendChild(span);
          ul.appendChild(li);
        });

        body.appendChild(ul);

        header.addEventListener('click', () => {
          const arrow = header.querySelector('.arrow');
          body.style.display = body.style.display === 'block' ? 'none' : 'block';
          arrow.classList.toggle('open');
        });

        collectionDiv.appendChild(header);
        collectionDiv.appendChild(body);
        contenedor.appendChild(collectionDiv);
      });

      actualizarProgresoGlobal();
    }

    init();
  </script>
</body>
</html>
